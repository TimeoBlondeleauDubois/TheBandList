@page "/envoyerunevideo"
@using Microsoft.EntityFrameworkCore
@using TheBandList.Data
@using Microsoft.AspNetCore.Components.Forms
@inject TheBandListDbContext _context

<PageTitle>Soumettre un niveau</PageTitle>

<h3>Soumettre un niveau</h3>

<EditForm Model="newSubmission">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label for="nomNiveau" class="form-label">Nom du niveau</label>
        <InputText id="nomNiveau" class="form-control" @bind-Value="newSubmission.NomNiveau" @oninput="OnNiveauInput" />
        <ul class="list-group">
            @if (niveauSuggestions.Any())
            {
                @foreach (var suggestion in niveauSuggestions)
                {
                    <li class="list-group-item" @onclick="(() => SelectNiveau(suggestion))">@suggestion</li>
                }
            }
        </ul>
    </div>

    <div class="mb-3">
        <label for="nomUtilisateur" class="form-label">Nom d'utilisateur</label>
        <InputText id="nomUtilisateur" class="form-control" @bind-Value="newSubmission.NomUtilisateur" @oninput="OnUtilisateurInput" />
        <ul class="list-group">
            @if (utilisateurSuggestions.Any())
            {
                @foreach (var suggestion in utilisateurSuggestions)
                {
                    <li class="list-group-item" @onclick="(() => SelectUtilisateur(suggestion))">@suggestion</li>
                }
            }
        </ul>
    </div>

    <div class="mb-3">
        <label for="urlVideo" class="form-label">URL de la vidéo</label>
        <InputText id="urlVideo" class="form-control" @bind-Value="newSubmission.UrlVideo" />
    </div>

    <button type="button" class="btn btn-primary" @onclick="ValidateAndSubmit">Soumettre</button>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="text-danger mt-2">@errorMessage</div>
    }

    @if (submissionSuccess)
    {
        <div class="text-success mt-2">Soumission réussie !</div>
    }
</EditForm>

@code {
    private SoumissionNiveau newSubmission = new SoumissionNiveau();
    private string errorMessage;
    private bool submissionSuccess;

    private List<string> niveauSuggestions = new();
    private List<string> utilisateurSuggestions = new();

    private async Task OnNiveauInput(ChangeEventArgs e)
    {
        string input = e.Value.ToString().ToLower();
        niveauSuggestions = await _context.Niveaux
            .Where(n => n.Nom.ToLower().Contains(input))
            .Select(n => n.Nom)
            .Take(5)
            .ToListAsync();
    }

    private async Task OnUtilisateurInput(ChangeEventArgs e)
    {
        string input = e.Value.ToString().ToLower();
        utilisateurSuggestions = await _context.Utilisateurs
            .Where(u => u.Nom.ToLower().Contains(input))
            .Select(u => u.Nom)
            .Take(5)
            .ToListAsync();
    }

    private void SelectNiveau(string nomNiveau)
    {
        newSubmission.NomNiveau = nomNiveau;
        niveauSuggestions.Clear();
    }

    private void SelectUtilisateur(string nomUtilisateur)
    {
        newSubmission.NomUtilisateur = nomUtilisateur;
        utilisateurSuggestions.Clear();
    }

    private void ValidateAndSubmit()
    {
        if (string.IsNullOrWhiteSpace(newSubmission.NomNiveau))
        {
            errorMessage = "Veuillez remplir le champ : Nom du niveau.";
            submissionSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(newSubmission.NomUtilisateur))
        {
            errorMessage = "Veuillez remplir le champ : Nom d'utilisateur.";
            submissionSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(newSubmission.UrlVideo))
        {
            errorMessage = "Veuillez remplir le champ : URL de la vidéo.";
            submissionSuccess = false;
            return;
        }

        errorMessage = string.Empty;
        submissionSuccess = false;

        _ = HandleValidSubmit();
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            newSubmission.DateSoumission = DateTime.Now;
            newSubmission.Statut = "pending";

            _context.SoumissionsNiveaux.Add(newSubmission);
            await _context.SaveChangesAsync();

            newSubmission = new SoumissionNiveau();
            submissionSuccess = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la soumission : {ex.Message}");
            submissionSuccess = false;
        }
        finally
        {
            StateHasChanged();
        }
    }
}
